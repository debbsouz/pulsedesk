<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PulseDesk · Settings</title>
  <link rel="stylesheet" href="../css/tokens.css">
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/components.css">
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <img src="../assets/logo.svg" alt="PulseDesk logo">
        <span class="name">PulseDesk</span>
      </div>
      <nav class="nav">
        <a href="./dashboard.html">Dashboard</a>
        <a href="./tickets.html">Tickets</a>
        <a href="./new-ticket.html">New Ticket</a>
        <a class="active" href="./settings.html">Settings</a>
        <a href="#">Logout</a>
      </nav>
    </aside>
    <div class="content">
      <header class="topbar">
        <div class="topbar-left">
          <a class="logo-inline" href="./dashboard.html">
            <img src="../assets/logo.svg" alt="PulseDesk logo">
            <span class="wordmark">PulseDesk</span>
          </a>
        </div>
        <div class="topbar-right">
          <div class="avatar">U</div>
        </div>
      </header>
      <main class="main">
        <h1 class="section-title">Settings</h1>
        <p class="page-subtitle">Configure agent profile, preferences, and data tools for your workspace.</p>
        <div id="settings-toast" aria-live="polite" aria-atomic="true"></div>
        <div class="cards">
          <div class="card">
            <div class="card-title">Profile</div>
            <div class="form">
              <div class="field">
                <label class="label" for="agent-name">Agent Name</label>
                <input class="input" id="agent-name" type="text" placeholder="Your name">
              </div>
              <div class="field">
                <label class="label" for="agent-email">Agent Email</label>
                <input class="input" id="agent-email" type="email" placeholder="you@example.com">
              </div>
              <div class="actions">
                <button class="button" id="save-profile">Save</button>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-title">Preferences</div>
            <div class="form">
              <div class="field">
                <label class="label" for="theme">Theme</label>
                <select class="select" id="theme">
                  <option value="light">Light</option>
                  <option value="dark">Dark</option>
                </select>
              </div>
              <div class="actions">
                <button class="button secondary" id="apply-theme">Apply</button>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-title">Data Management</div>
            <div class="actions">
              <button class="button secondary" id="create-demo">Create demo data</button>
              <button class="button" id="clear-data">Clear all data</button>
            </div>
            <p class="muted">Clearing data removes tickets only. Settings are preserved.</p>
          </div>
          <div class="card">
            <div class="card-title">Backup & Restore</div>
            <div class="form">
              <div class="actions">
                <button class="button" id="export-json">Export tickets (.json)</button>
              </div>
              <div class="field">
                <label class="label" for="import-file">Import tickets (JSON)</label>
                <input class="input" id="import-file" type="file" accept=".json,application/json">
                <div id="import-error" class="muted" aria-live="polite"></div>
              </div>
              <div class="actions">
                <button class="button secondary" id="import-json">Import tickets</button>
                <a id="import-success-link" class="button" href="./tickets.html" style="display:none">Go to Tickets</a>
              </div>
              <p class="muted">Import restores tickets from a JSON backup. Existing tickets will be replaced after confirmation.</p>
            </div>
          </div>
        </div>
        <footer class="footer">PulseDesk © 2026 – Internal Support Platform.</footer>
      </main>
    </div>
  </div>
<script src="../js/app.js"></script>
<script src="../js/storage.js"></script>
<script src="../js/seed.js"></script>
<script>
  (function(){
    var S = window.PulseDeskStorage;
    if (!S) return;
    var $name = document.getElementById("agent-name");
    var $email = document.getElementById("agent-email");
    var $save = document.getElementById("save-profile");
    var $theme = document.getElementById("theme");
    var $apply = document.getElementById("apply-theme");
    var $create = document.getElementById("create-demo");
    var $clear = document.getElementById("clear-data");
    var $toast = document.getElementById("settings-toast");
    var $export = document.getElementById("export-json");
    var $importFile = document.getElementById("import-file");
    var $importBtn = document.getElementById("import-json");
    var $importErr = document.getElementById("import-error");
    var $importSuccessLink = document.getElementById("import-success-link");
    function toast(msg, type){ if (window.PulseDeskUI && window.PulseDeskUI.toast) window.PulseDeskUI.toast(msg, type); }
    function applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme==="dark" ? "dark" : "light");
    }
    function init(){
      var st = S.getSettings();
      $name.value = st.agentName || "";
      $email.value = st.agentEmail || "";
      $theme.value = st.theme || "light";
      applyTheme(st.theme);
    }
    function ymd(date){
      var d = date || new Date();
      var y = d.getFullYear();
      var m = String(d.getMonth()+1).padStart(2,"0");
      var day = String(d.getDate()).padStart(2,"0");
      return y+"-"+m+"-"+day;
    }
    $export.addEventListener("click", function(){
      var data = {
        version: 1,
        exportedAt: new Date().toISOString(),
        tickets: S.getTickets()
      };
      var blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      var a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "pulsedesk-tickets-"+ymd(new Date())+".json";
      document.body.appendChild(a);
      a.click();
      setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); }, 0);
      toast("Exported");
    });
    function validateImportShape(obj){
      if (!obj || typeof obj!=="object") return false;
      if (!Array.isArray(obj.tickets)) return false;
      for (var i=0;i<obj.tickets.length;i++){
        var t = obj.tickets[i] || {};
        if (!t.id || !t.createdAt || !t.status || !t.priority || !(t.subject || t.title)) return false;
      }
      return true;
    }
    var pendingImport = null;
    $importBtn.addEventListener("click", function(){
      $importErr.textContent = "";
      $importSuccessLink.style.display = "none";
      var f = $importFile.files && $importFile.files[0];
      if (!f){ $importErr.textContent = "Please choose a JSON file."; return; }
      var name = String(f.name||"");
      if (name.slice(-5).toLowerCase() !== ".json"){ $importErr.textContent = "Only .json files are accepted."; return; }
      var reader = new FileReader();
      reader.onload = function(e){
        var text = String(e.target.result||"");
        var obj;
        try { obj = JSON.parse(text); } catch(err){ $importErr.textContent = "Invalid JSON format."; return; }
        if (!validateImportShape(obj)){ $importErr.textContent = "Invalid backup structure."; return; }
        pendingImport = obj.tickets;
        showConfirm();
      };
      reader.onerror = function(){ $importErr.textContent = "Failed to read file."; };
      reader.readAsText(f);
    });
    function showConfirm(){
      var overlay = document.getElementById("confirm-overlay");
      overlay.style.display = "flex";
    }
    function hideConfirm(){
      var overlay = document.getElementById("confirm-overlay");
      overlay.style.display = "none";
    }
    function doImport(){
      if (!pendingImport) return;
      S.saveTickets(pendingImport);
      pendingImport = null;
      hideConfirm();
      toast("Import successful");
      $importSuccessLink.style.display = "inline-flex";
    }
    document.getElementById("confirm-yes").addEventListener("click", doImport);
    document.getElementById("confirm-cancel").addEventListener("click", function(){ pendingImport=null; hideConfirm(); });
    $save.addEventListener("click", function(){
      $save.disabled = true;
      var prevText = $save.textContent; $save.textContent = "Saving...";
      var st = S.getSettings();
      st.agentName = ($name.value||"").trim() || "You";
      st.agentEmail = ($email.value||"").trim();
      S.saveSettings(st);
      toast("Profile saved");
      $save.textContent = prevText; $save.disabled = false;
    });
    $apply.addEventListener("click", function(){
      $apply.disabled = true; var prevText = $apply.textContent; $apply.textContent = "Applying...";
      var val = $theme.value || "light";
      S.setTheme(val);
      applyTheme(val);
      toast("Theme applied");
      $apply.textContent = prevText; $apply.disabled = false;
    });
    $create.addEventListener("click", function(){
      $create.disabled = true; var prev = $create.textContent; $create.textContent = "Creating...";
      var ok = S.createDemoData();
      toast(ok ? "Demo data created" : "Tickets already exist");
      $create.textContent = prev; $create.disabled = false;
    });
    $clear.addEventListener("click", function(){
      $clear.disabled = true; var prev = $clear.textContent; $clear.textContent = "Clearing...";
      S.clearTickets();
      toast("All tickets cleared");
      $clear.textContent = prev; $clear.disabled = false;
    });
    init();
  })();
</script>
<div id="confirm-overlay" class="modal-overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirm-title" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div id="confirm-title">Confirm Import</div>
      <button class="button secondary" id="confirm-cancel">Cancel</button>
    </div>
    <p>Importing will replace existing tickets with the ones from the backup. Continue?</p>
    <div style="height:8px"></div>
    <div class="actions">
      <button class="button" id="confirm-yes">Confirm import</button>
    </div>
  </div>
</div>
</body>
</html>
