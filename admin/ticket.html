<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PulseDesk · Ticket</title>
  <link rel="stylesheet" href="../css/tokens.css">
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/components.css">
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <img src="../assets/logo.svg" alt="PulseDesk logo">
        <span class="name">PulseDesk</span>
      </div>
      <nav class="nav">
        <a href="./dashboard.html">Dashboard</a>
        <a class="active" href="./tickets.html">Tickets</a>
        <a href="./new-ticket.html">New Ticket</a>
        <a href="./settings.html">Settings</a>
        <a href="#">Logout</a>
      </nav>
    </aside>
    <div class="content">
      <header class="topbar">
        <div class="topbar-left">
          <a class="logo-inline" href="./dashboard.html">
            <img src="../assets/logo.svg" alt="PulseDesk logo">
            <span class="wordmark">PulseDesk</span>
          </a>
        </div>
        <div class="topbar-right">
          <div class="avatar">U</div>
        </div>
      </header>
      <main class="main">
        <div id="toast" aria-live="polite" aria-atomic="true"></div>
        <div id="not-found" class="card" style="display:none">
          <h2>Ticket not found</h2>
          <div style="height:12px"></div>
          <a class="button" href="./tickets.html">Back to tickets</a>
        </div>
        <div id="detail" style="display:none">
          <div class="card" id="header-card">
            <h1 class="section-title" id="header-title"></h1>
            <div id="header-badges"></div>
          </div>
          <div class="card">
            <div class="card-title">Summary</div>
            <div class="summary-grid">
              <div><div class="label">Subject</div><div id="sum-subject">—</div></div>
              <div><div class="label">Created</div><div id="sum-created">—</div></div>
              <div><div class="label">Category</div><div id="sum-category">—</div></div>
              <div><div class="label">Priority</div><div id="sum-priority">—</div></div>
              <div><div class="label">Status</div><div id="sum-status">—</div></div>
              <div><div class="label">Requester Email</div><div id="sum-email">—</div></div>
            </div>
          </div>
          <div class="card">
            <div class="card-title">Description</div>
            <div id="desc">—</div>
          </div>
          <div class="card">
            <div class="card-title">Update</div>
            <div class="field">
              <label class="label" for="status">Status</label>
              <select class="select" id="status">
                <option value="open">Open</option>
                <option value="in_progress">Pending</option>
                <option value="resolved">Resolved</option>
              </select>
            </div>
            <div class="field">
              <label class="label" for="priority">Priority</label>
              <select class="select" id="priority">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>
            <div class="field">
              <label class="label" for="assignee">Assign to</label>
              <select class="select" id="assignee">
                <option value="">Unassigned</option>
                <option>John</option>
                <option>Sarah</option>
                <option>Mike</option>
              </select>
            </div>
            <div class="field">
              <label class="label" for="note">Internal Notes</label>
              <textarea class="textarea" id="note" placeholder="Add internal note"></textarea>
            </div>
            <div class="field">
              <label class="label" for="files">Add attachments</label>
              <input class="input" id="files" type="file" multiple>
              <div id="file-error" class="muted" aria-live="polite"></div>
            </div>
            <div class="actions">
              <button class="button" id="save">Save changes</button>
              <button class="button secondary" id="add-attachment">Add attachment</button>
              <a class="button secondary" href="./tickets.html">Back to Tickets</a>
            </div>
          </div>
          <div class="split">
            <div class="card">
              <div class="card-title">Conversation</div>
              <div id="comments"></div>
              <div style="height:12px"></div>
              <div class="field">
                <label class="label" for="c-author">Author</label>
                <select class="select" id="c-author">
                  <option>Requester</option>
                  <option>Agent</option>
                </select>
              </div>
              <div class="field">
                <label class="label" for="c-text">Message</label>
                <textarea class="textarea" id="c-text" placeholder="Write a comment"></textarea>
              </div>
              <div class="actions">
                <button class="button" id="post-comment">Post comment</button>
              </div>
            </div>
            <div class="card">
              <div class="card-title">Attachments</div>
              <div id="attachments"></div>
            </div>
          </div>
          <div class="card">
            <div class="card-title">History</div>
            <div class="timeline" id="history"></div>
          </div>
        </div>
      </main>
    </div>
  </div>
<script src="../js/app.js"></script>
<script src="../js/storage.js"></script>
<script src="../js/seed.js"></script>
<script>
  (function () {
    var S = window.PulseDeskStorage;
    if (!S) return;
    var params = new URLSearchParams(window.location.search);
    var id = params.get("id");
    var $nf = document.getElementById("not-found");
    var $detail = document.getElementById("detail");
    var $title = document.getElementById("header-title");
    var $badges = document.getElementById("header-badges");
    var $sumSubject = document.getElementById("sum-subject");
    var $sumCreated = document.getElementById("sum-created");
    var $sumPriority = document.getElementById("sum-priority");
    var $sumCategory = document.getElementById("sum-category");
    var $sumStatus = document.getElementById("sum-status");
    var $sumEmail = document.getElementById("sum-email");
    var $desc = document.getElementById("desc");
    var $note = document.getElementById("note");
    var $status = document.getElementById("status");
    var $assignee = document.getElementById("assignee");
    var $priority = document.getElementById("priority");
    var $save = document.getElementById("save");
    var $hist = document.getElementById("history");
    var $toast = document.getElementById("toast");
    var $comments = document.getElementById("comments");
    var $cAuthor = document.getElementById("c-author");
    var $cText = document.getElementById("c-text");
    var $post = document.getElementById("post-comment");
    var $attachments = document.getElementById("attachments");
    var $files = document.getElementById("files");
    var $fileError = document.getElementById("file-error");
    var $addAttachment = document.getElementById("add-attachment");
    function shortId(s) { s = String(s||""); return s.length>6?s.slice(-6):s; }
    function formatDate(s) { try { var d = new Date(s); return d.toLocaleString(); } catch(e){ return s||""; } }
    function statusLabel(v){ var m={open:"Open", in_progress:"Pending", resolved:"Resolved", closed:"Closed"}; return m[v]||v||""; }
    function statusClass(v){ var m={open:"open", in_progress:"pending", resolved:"resolved", closed:"closed"}; return m[v]||"open"; }
    function priorityLabel(v){ var m={low:"Low", medium:"Medium", high:"High", urgent:"Urgent"}; return m[v]||v||""; }
    function priorityClass(v){ var m={low:"low", medium:"medium", high:"high", urgent:"urgent"}; return m[v]||"low"; }
    function showToast(msg, type){ if (window.PulseDeskUI && window.PulseDeskUI.toast) window.PulseDeskUI.toast(msg, type); }
    function normalizeTicket(t){
      var subject = t.subject || t.title || "";
      var email = t.requesterEmail || "";
      var history = Array.isArray(t.history)? t.history : [];
      var mapped = history.map(function(h){
        if (h && h.type) return h;
        return { type: "event", message: String(h && h.action || "updated"), at: h && h.at ? h.at : new Date().toISOString() };
      });
      var out = {
        id: t.id,
        createdAt: t.createdAt || new Date().toISOString(),
        subject: subject,
        description: t.description || "",
        category: t.category || "",
        requesterEmail: email,
        priority: t.priority || "low",
        status: t.status || "open",
        assignee: t.assignee || "",
        internalNotes: t.internalNotes || t.internalNote || "",
        history: mapped,
        comments: Array.isArray(t.comments) ? t.comments : [],
        attachments: Array.isArray(t.attachments) ? t.attachments : []
      };
      if (!out.history.some(function(e){ return e && e.type==="created"; })) {
        out.history.unshift({ type: "created", at: out.createdAt });
      }
      return out;
    }
    function load(){
      var t = S.getTicketById(id);
      if (!t){ $nf.style.display="block"; return; }
      t = normalizeTicket(t);
      $detail.style.display="block";
      $title.textContent = "Ticket #" + shortId(t.id);
      $badges.innerHTML = "<span class='badge badge-status "+statusClass(t.status)+"'>"+statusLabel(t.status)+"</span>";
      $sumSubject.textContent = t.subject || "—";
      $sumCreated.textContent = formatDate(t.createdAt);
      $sumPriority.innerHTML = "<span class='badge badge-priority "+priorityClass(t.priority)+"'>"+priorityLabel(t.priority)+"</span>";
      $sumStatus.innerHTML = "<span class='badge badge-status "+statusClass(t.status)+"'>"+statusLabel(t.status)+"</span>";
      $sumCategory.textContent = t.category || "—";
      $sumEmail.textContent = t.requesterEmail || "—";
      $desc.textContent = t.description || "—";
      $note.value = t.internalNotes || "";
      $status.value = t.status;
      $priority.value = t.priority;
      $assignee.value = t.assignee || "";
      renderHistory(t.history);
      renderComments(t.comments);
      renderAttachments(t.attachments);
    }
    function renderHistory(list){
      if (!list || list.length===0){ $hist.innerHTML = "<div class='muted'>No history yet.</div>"; return; }
      var html = list.slice().sort(function(a,b){
        return new Date(b.at).getTime() - new Date(a.at).getTime();
      }).map(function(h){
        var when = formatDate(h.at);
        var type = h.type || "event";
        var msg = "";
        if (type === "created") msg = "Ticket created";
        else if (type === "status") msg = "Status: " + (h.from || "") + " → " + (h.to || "");
        else if (type === "priority") msg = "Priority: " + (h.from || "") + " → " + (h.to || "");
        else if (type === "assignee") msg = "Assignee: " + (h.from || "Unassigned") + " → " + (h.to || "Unassigned");
        else if (type === "note") msg = "Internal note updated";
        else msg = h.message || h.action || "";
        return "<div class='timeline-item'><div class='dot'></div><div class='content'><div class='time'>"+when+"</div><div class='msg'>"+msg+"</div></div></div>";
      }).join("");
      $hist.innerHTML = html;
    }
    function renderComments(list){
      if (!list || list.length===0){ $comments.innerHTML = "<div class='muted'>No comments yet.</div>"; return; }
      var html = list.slice().sort(function(a,b){
        return new Date(a.at).getTime() - new Date(b.at).getTime();
      }).map(function(c){
        return "<div style='margin-bottom:12px'>"
          +"<div style='display:flex;justify-content:space-between'><strong>"+(c.author||"")+"</strong><span class='muted'>"+formatDate(c.at)+"</span></div>"
          +"<div>"+(c.text||"")+"</div>"
        +"</div>";
      }).join("");
      $comments.innerHTML = html;
    }
    function prettySize(bytes){
      var b = Number(bytes||0); if (b<1024) return b+" B"; var kb=b/1024; if (kb<1024) return Math.round(kb)+" KB"; var mb=kb/1024; return (Math.round(mb*10)/10)+" MB";
    }
    function renderAttachments(list){
      if (!list || list.length===0){ $attachments.innerHTML = "<div class='muted'>No attachments.</div>"; return; }
      var html = list.slice().sort(function(a,b){
        var ab = new Date(b.uploadedAt || b.at).getTime();
        var aa = new Date(a.uploadedAt || a.at).getTime();
        return ab - aa;
      }).map(function(a,i){
        return "<div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:8px'>"
          +"<div><div><strong>"+(a.name||"")+"</strong></div>"
          +"<div class='muted'>"+(a.type||"")+", "+prettySize(a.size)+" • "+formatDate(a.uploadedAt || a.at)+"</div></div>"
          +"<div><button class='button secondary' data-url='"+(a.dataUrl||"")+"' data-type='"+(a.type||"")+"' data-name='"+(a.name||"")+"' onclick=''>Open</button></div>"
        +"</div>";
      }).join("");
      $attachments.innerHTML = html;
      Array.prototype.forEach.call($attachments.querySelectorAll("button"), function(btn){
        btn.addEventListener("click", function(){
          var url = btn.getAttribute("data-url")||"";
          var type = btn.getAttribute("data-type")||"";
          var name = btn.getAttribute("data-name")||"file";
          if (type.indexOf("image/")===0){
            openImagePreview(url, name);
          } else {
            var a = document.createElement("a");
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            a.remove();
          }
        });
      });
    }
    function saveDisabled(btn, disabled){
      btn.disabled = !!disabled;
    }
    function persistAndAnnounce(updated, event){
      var r = S.updateTicket(updated);
      if (!r) return;
      showToast("Saved");
      var t = normalizeTicket(r);
      renderHistory(t.history);
      renderComments(t.comments);
      renderAttachments(t.attachments);
    }
    $save.addEventListener("click", function(){
      saveDisabled($save, true);
      var st = $status.value;
      var asn = $assignee.value || "";
      var noteVal = $note.value || "";
      var pr = $priority.value;
      setTimeout(function(){
        var t = S.getTicketById(id);
        if (!t){ saveDisabled($save,false); return; }
        var hist = Array.isArray(t.history)? t.history : [];
        if (String(t.status) !== String(st)){
          hist.push({ type: "status", from: statusLabel(t.status), to: statusLabel(st), at: new Date().toISOString() });
        }
        if (String(t.assignee || "") !== String(asn)){
          hist.push({ type: "assignee", from: (t.assignee || "Unassigned"), to: (asn || "Unassigned"), at: new Date().toISOString() });
        }
        if (String(t.priority || "") !== String(pr)){
          hist.push({ type: "priority", from: priorityLabel(t.priority), to: priorityLabel(pr), at: new Date().toISOString() });
        }
        if (String(t.internalNote || "") !== String(noteVal)){
          hist.push({ type: "note", at: new Date().toISOString() });
        }
        var updates = { id: id, status: st, priority: pr, assignee: asn, internalNotes: noteVal, internalNote: noteVal, history: hist };
        var events = Array.isArray(t.events)? t.events.slice() : [];
        if (String(t.status) !== String(st)){
          events.push({ id: "e_"+Date.now().toString(36), at: new Date().toISOString(), type: "status", from: statusLabel(t.status), to: statusLabel(st) });
        }
        if (String(t.assignee || "") !== String(asn)){
          events.push({ id: "e_"+Date.now().toString(36), at: new Date().toISOString(), type: "assignee", from: (t.assignee || "Unassigned"), to: (asn || "Unassigned") });
        }
        if (String(t.priority || "") !== String(pr)){
          events.push({ id: "e_"+Date.now().toString(36), at: new Date().toISOString(), type: "priority", from: priorityLabel(t.priority), to: priorityLabel(pr) });
        }
        updates.events = events;
        if (!t.firstResponseAt && String(t.status)==="open" && String(st)!=="open"){
          updates.firstResponseAt = new Date().toISOString();
          hist.push({ type: "first_response", at: updates.firstResponseAt });
        }
        if (!t.resolvedAt && String(st)==="resolved"){
          updates.resolvedAt = new Date().toISOString();
          hist.push({ type: "resolved", at: updates.resolvedAt });
        }
        if (t.resolvedAt && String(st)!=="resolved"){
          updates.resolvedAt = null;
        }
        persistAndAnnounce(updates);
        $sumStatus.innerHTML = "<span class='badge badge-status "+statusClass(st)+"'>"+statusLabel(st)+"</span>";
        $sumPriority.innerHTML = "<span class='badge badge-priority "+priorityClass(pr)+"'>"+priorityLabel(pr)+"</span>";
        $badges.innerHTML = "<span class='badge badge-status "+statusClass(st)+"'>"+statusLabel(st)+"</span>";
        saveDisabled($save, false);
      }, 500);
    });
    function rid(){ return "c_"+Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
    $post.addEventListener("click", function(){
      var txt = ($cText.value||"").trim();
      if (!txt){ $cText.focus(); return; }
      saveDisabled($post, true);
      var author = $cAuthor.value || "Agent";
      setTimeout(function(){
        var t = S.getTicketById(id);
        if (!t){ saveDisabled($post,false); return; }
        var comments = Array.isArray(t.comments)? t.comments.slice() : [];
        var at = new Date().toISOString();
        comments.push({ id: rid(), at: at, author: author, text: txt });
        var events = Array.isArray(t.events)? t.events.slice() : [];
        events.push({ id: "e_"+Date.now().toString(36), at: at, type: "comment", author: author, preview: txt.slice(0,50) });
        var updates = { id: id, comments: comments, events: events };
        var isAgent = String(author).toLowerCase() === "agent";
        if (!t.firstAgentReplyAt && isAgent) {
          updates.firstAgentReplyAt = at;
        }
        persistAndAnnounce(updates);
        showToast("Comment posted");
        $cText.value = "";
        $cText.focus();
        saveDisabled($post, false);
      }, 300);
    });
    function readFilesAsDataUrls(files, cb){
      var out = [];
      var i = 0;
      function next(){
        if (i >= files.length) { cb(out); return; }
        var f = files[i++];
        var reader = new FileReader();
        reader.onload = function(e){
          out.push({ name: f.name, type: f.type || "application/octet-stream", size: f.size, dataUrl: e.target.result });
          next();
        };
        reader.onerror = function(){ next(); };
        reader.readAsDataURL(f);
      }
      next();
    }
    $addAttachment.addEventListener("click", function(){
      var files = $files.files;
      if (!files || files.length===0){ $files.focus(); return; }
      var tooBig = false;
      for (var i=0;i<files.length;i++){
        if (files[i].size > 2 * 1024 * 1024) { tooBig = true; break; }
      }
      if (tooBig){
        $fileError.textContent = "Each file must be 2MB or less.";
        return;
      }
      $fileError.textContent = "";
      saveDisabled($addAttachment, true);
      var at = new Date().toISOString();
      readFilesAsDataUrls(files, function(items){
        var t = S.getTicketById(id);
        if (!t){ saveDisabled($addAttachment,false); return; }
        var attachments = Array.isArray(t.attachments)? t.attachments.slice() : [];
        var events = Array.isArray(t.events)? t.events.slice() : [];
        items.forEach(function(it){
          var a = { id: "a_"+Date.now().toString(36)+Math.random().toString(36).slice(2,6), name: it.name, type: it.type, size: it.size, dataUrl: it.dataUrl, uploadedAt: new Date().toISOString() };
          attachments.push(a);
          events.push({ id: "e_"+Date.now().toString(36), at: at, type: "attachment", name: it.name, size: it.size });
        });
        persistAndAnnounce({ id: id, attachments: attachments, events: events });
        showToast("Attachments added");
        $files.value = "";
        saveDisabled($addAttachment, false);
      });
    });
    function openImagePreview(url, name){
      var overlay = document.getElementById("preview-overlay");
      var img = document.getElementById("preview-img");
      var title = document.getElementById("preview-title");
      img.src = url;
      title.textContent = name || "Preview";
      overlay.style.display = "flex";
    }
    function closePreview(){
      var overlay = document.getElementById("preview-overlay");
      var img = document.getElementById("preview-img");
      img.src = "";
      overlay.style.display = "none";
    }
    window.closePreview = closePreview;
    load();
  })();
</script>
<div id="preview-overlay" class="modal-overlay" onclick="closePreview()" aria-hidden="true">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div id="preview-title">Preview</div>
      <button class="button secondary" onclick="closePreview()">Close</button>
    </div>
    <img id="preview-img" alt="Attachment preview">
  </div>
</div>
</body>
</html>
