<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PulseDesk · Ticket</title>
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/components.css">
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <img src="../assets/logo.svg" alt="PulseDesk logo">
        <span class="name">PulseDesk</span>
      </div>
      <nav class="nav">
        <a href="./dashboard.html">Dashboard</a>
        <a href="./tickets.html">Tickets</a>
        <a href="./new-ticket.html">New Ticket</a>
        <a href="#">Settings</a>
        <a href="#">Logout</a>
      </nav>
    </aside>
    <div class="content">
      <header class="topbar">
        <div class="topbar-left">
          <a class="logo-inline" href="./dashboard.html">
            <img src="../assets/logo.svg" alt="PulseDesk logo">
            <span class="wordmark">PulseDesk</span>
          </a>
        </div>
        <div class="topbar-right">
          <div class="avatar">U</div>
        </div>
      </header>
      <main class="main">
        <div id="toast" aria-live="polite" aria-atomic="true"></div>
        <div id="not-found" class="card" style="display:none">
          <h2>Ticket not found</h2>
          <div style="height:12px"></div>
          <a class="button" href="./dashboard.html">Back to dashboard</a>
        </div>
        <div id="detail" style="display:none">
          <div class="card" id="header-card">
            <h1 class="section-title" id="header-title"></h1>
            <div id="header-badges"></div>
          </div>
          <div class="card">
            <div class="card-title">Summary</div>
            <div class="summary-grid">
              <div><div class="label">Subject</div><div id="sum-subject">—</div></div>
              <div><div class="label">Created</div><div id="sum-created">—</div></div>
              <div><div class="label">Category</div><div id="sum-category">—</div></div>
              <div><div class="label">Priority</div><div id="sum-priority">—</div></div>
              <div><div class="label">Status</div><div id="sum-status">—</div></div>
              <div><div class="label">Requester Email</div><div id="sum-email">—</div></div>
            </div>
          </div>
          <div class="card">
            <div class="card-title">Description</div>
            <div id="desc">—</div>
          </div>
          <div class="card">
            <div class="card-title">Update</div>
            <div class="field">
              <label class="label" for="status">Status</label>
              <select class="select" id="status">
                <option value="open">Open</option>
                <option value="in_progress">Pending</option>
                <option value="resolved">Resolved</option>
              </select>
            </div>
            <div class="field">
              <label class="label" for="note">Internal Notes</label>
              <textarea class="textarea" id="note" placeholder="Add internal note"></textarea>
            </div>
            <div class="actions">
              <button class="button" id="save">Save</button>
            </div>
          </div>
          <div class="card">
            <div class="card-title">History</div>
            <div class="timeline" id="history"></div>
          </div>
        </div>
      </main>
    </div>
  </div>
<script src="../js/storage.js"></script>
<script src="../js/seed.js"></script>
<script>
  (function () {
    var S = window.PulseDeskStorage;
    if (!S) return;
    var params = new URLSearchParams(window.location.search);
    var id = params.get("id");
    var $nf = document.getElementById("not-found");
    var $detail = document.getElementById("detail");
    var $title = document.getElementById("header-title");
    var $badges = document.getElementById("header-badges");
    var $sumSubject = document.getElementById("sum-subject");
    var $sumCreated = document.getElementById("sum-created");
    var $sumPriority = document.getElementById("sum-priority");
    var $sumCategory = document.getElementById("sum-category");
    var $sumStatus = document.getElementById("sum-status");
    var $sumEmail = document.getElementById("sum-email");
    var $desc = document.getElementById("desc");
    var $note = document.getElementById("note");
    var $status = document.getElementById("status");
    var $priority = null;
    var $save = document.getElementById("save");
    var $hist = document.getElementById("history");
    var $toast = document.getElementById("toast");
    function shortId(s) { s = String(s||""); return s.length>6?s.slice(-6):s; }
    function formatDate(s) { try { var d = new Date(s); return d.toLocaleString(); } catch(e){ return s||""; } }
    function statusLabel(v){ var m={open:"Open", in_progress:"Pending", resolved:"Resolved", closed:"Closed"}; return m[v]||v||""; }
    function statusClass(v){ var m={open:"open", in_progress:"pending", resolved:"resolved", closed:"closed"}; return m[v]||"open"; }
    function priorityLabel(v){ var m={low:"Low", medium:"Medium", high:"High", urgent:"Urgent"}; return m[v]||v||""; }
    function priorityClass(v){ var m={low:"low", medium:"medium", high:"high", urgent:"urgent"}; return m[v]||"low"; }
    function showToast(msg){
      $toast.innerHTML = "<div class='toast toast-success'>" + msg + "</div>";
      setTimeout(function(){ $toast.innerHTML=""; }, 2000);
    }
    function normalizeTicket(t){
      var subject = t.subject || t.title || "";
      var email = t.requesterEmail || "";
      var history = Array.isArray(t.history)? t.history : [];
      var mapped = history.map(function(h){
        if (h && h.type) return h;
        return { type: "event", message: String(h && h.action || "updated"), at: h && h.at ? h.at : new Date().toISOString() };
      });
      return {
        id: t.id,
        createdAt: t.createdAt || new Date().toISOString(),
        subject: subject,
        description: t.description || "",
        category: t.category || "",
        requesterEmail: email,
        priority: t.priority || "low",
        status: t.status || "open",
        internalNote: t.internalNote || "",
        history: mapped
      };
    }
    function load(){
      var t = S.getTicketById(id);
      if (!t){ $nf.style.display="block"; return; }
      t = normalizeTicket(t);
      $detail.style.display="block";
      $title.textContent = "Ticket #" + shortId(t.id);
      $badges.innerHTML = "<span class='badge badge-status "+statusClass(t.status)+"'>"+statusLabel(t.status)+"</span>";
      $sumSubject.textContent = t.subject || "—";
      $sumCreated.textContent = formatDate(t.createdAt);
      $sumPriority.innerHTML = "<span class='badge badge-priority "+priorityClass(t.priority)+"'>"+priorityLabel(t.priority)+"</span>";
      $sumStatus.innerHTML = "<span class='badge badge-status "+statusClass(t.status)+"'>"+statusLabel(t.status)+"</span>";
      $sumCategory.textContent = t.category || "—";
      $sumEmail.textContent = t.requesterEmail || "—";
      $desc.textContent = t.description || "—";
      $note.value = t.internalNote || "";
      $status.value = t.status;
      renderHistory(t.history);
    }
    function renderHistory(list){
      if (!list || list.length===0){ $hist.innerHTML = "<div class='muted'>No history yet.</div>"; return; }
      var html = list.slice().sort(function(a,b){
        return new Date(b.at).getTime() - new Date(a.at).getTime();
      }).map(function(h){
        var when = formatDate(h.at);
        var msg = h.message || h.action || "";
        var type = h.type || "event";
        return "<div class='timeline-item'><div class='dot'></div><div class='content'><div class='time'>"+when+"</div><div class='msg'>"+type+": "+msg+"</div></div></div>";
      }).join("");
      $hist.innerHTML = html;
    }
    function saveDisabled(btn, disabled){
      btn.disabled = !!disabled;
    }
    function persistAndAnnounce(updated, event){
      var r = S.updateTicket(updated);
      if (!r) return;
      showToast("Saved");
      var t = normalizeTicket(r);
      renderHistory(t.history);
    }
    $save.addEventListener("click", function(){
      saveDisabled($save, true);
      var st = $status.value;
      var noteVal = $note.value || "";
      setTimeout(function(){
        var t = S.getTicketById(id);
        if (!t){ saveDisabled($save,false); return; }
        var hist = Array.isArray(t.history)? t.history : [];
        if (String(t.status) !== String(st)){
          hist.push({ type: "status", message: "Status changed to "+statusLabel(st), at: new Date().toISOString() });
        }
        if (String(t.internalNote || "") !== String(noteVal)){
          hist.push({ type: "note", message: "Internal note updated", at: new Date().toISOString() });
        }
        persistAndAnnounce({ id: id, status: st, internalNote: noteVal, history: hist });
        $sumStatus.innerHTML = "<span class='badge badge-status "+statusClass(st)+"'>"+statusLabel(st)+"</span>";
        $badges.innerHTML = "<span class='badge badge-status "+statusClass(st)+"'>"+statusLabel(st)+"</span>";
        saveDisabled($save, false);
      }, 500);
    });
    load();
  })();
</script>
</body>
</html>
