<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PulseDesk · Dashboard</title>
  <link rel="stylesheet" href="../css/tokens.css">
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/components.css">
</head>
<body>
  <div class="app">
    <aside class="sidebar" aria-label="Primary">
      <div class="brand">
        <img src="../assets/logo.svg" alt="PulseDesk logo">
        <span class="name">PulseDesk</span>
      </div>
      <nav class="nav">
        <a class="nav-item active" href="./dashboard.html" aria-label="Dashboard" title="Dashboard"><span class="nav-ic" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M4 4h7v7H4V4zm9 0h7v5h-7V4zM4 13h7v7H4v-7zm9-2h7v9h-7v-9z"/></svg></span><span class="nav-label">Dashboard</span></a>
        <a class="nav-item" href="./tickets.html" aria-label="Tickets" title="Tickets"><span class="nav-ic" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M4 6h16v10H7l-3 3V6z"/></svg></span><span class="nav-label">Tickets</span></a>
        <a class="nav-item" href="./new-ticket.html" aria-label="New Ticket" title="New Ticket"><span class="nav-ic" aria-hidden="true"><svg viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" stroke-linecap="round" d="M12 5v14M5 12h14"/></svg></span><span class="nav-label">New Ticket</span></a>
        <a class="nav-item" href="#" aria-label="Chats" title="Chats"><span class="nav-ic" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M4 5h16v10H7l-3 3V5z"/></svg></span><span class="nav-label">Chats</span></a>
        <a class="nav-item" href="#" aria-label="Customers" title="Customers"><span class="nav-ic" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm-7 8a7 7 0 0 1 14 0H5z"/></svg></span><span class="nav-label">Customers</span></a>
        <a class="nav-item" href="#" aria-label="Resources" title="Resources"><span class="nav-ic" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18v4H3V4zm0 6h18v4H3v-4zm0 6h18v4H3v-4z"/></svg></span><span class="nav-label">Resources</span></a>
        <a class="nav-item" href="#" aria-label="Contracts" title="Contracts"><span class="nav-ic" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M6 3h12v18H6zM9 7h6v2H9zM9 11h6v2H9zM9 15h6v2H9z"/></svg></span><span class="nav-label">Contracts</span></a>
        <a class="nav-item" href="#" aria-label="Reports" title="Reports"><span class="nav-ic" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M5 13h4v8H5v-8zm5-6h4v14h-4V7zm5 3h4v11h-4V10z"/></svg></span><span class="nav-label">Reports</span></a>
        <a class="nav-item" href="#" aria-label="Schedule" title="Schedule"><span class="nav-ic" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M7 2h2v3h6V2h2v3h3v15H4V5h3V2zm0 7h10v9H7V9z"/></svg></span><span class="nav-label">Schedule</span></a>
        <a class="nav-item" href="#" aria-label="Knowledge Base" title="Knowledge Base"><span class="nav-ic" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M4 5h14a2 2 0 0 1 2 2v12l-4-2-4 2-4-2-4 2V7a2 2 0 0 1 2-2z"/></svg></span><span class="nav-label">Knowledge Base</span></a>
        <a class="nav-item" href="#" aria-label="Password Vault" title="Password Vault"><span class="nav-ic" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 3a6 6 0 0 0-6 6v3H5a2 2 0 0 0-2 2v5h18v-5a2 2 0 0 0-2-2h-1V9a6 6 0 0 0-6-6zm-2 9h4v3h-4v-3z"/></svg></span><span class="nav-label">Password Vault</span></a>
        <a class="nav-item" href="./settings.html" aria-label="Settings" title="Settings"><span class="nav-ic" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg></span><span class="nav-label">Settings</span></a>
        <a class="nav-item" href="#" aria-label="Logout" title="Logout"><span class="nav-ic" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-width="2" d="M8 4h8v16H8"/><path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M12 8l4 4-4 4M4 12h12"/></svg></span><span class="nav-label">Logout</span></a>
      </nav>
      <div class="nav-cta">
        <a class="new-ticket-cta" href="./new-ticket.html">New Ticket</a>
      </div>
      <div class="sidebar-footer">
        <div class="footer-inner">
          <div class="avatar">U</div>
          <div class="user-text">
            <div class="user-name">You</div>
            <div class="user-email">you@example.com</div>
          </div>
          <button id="themeToggle" class="theme-btn" type="button" aria-label="Toggle theme" title="Toggle theme">
            <svg viewBox="0 0 24 24" aria-hidden="true" class="theme-icon">
              <path class="sun" d="M12 7a5 5 0 1 1 0 10 5 5 0 0 1 0-10zm0-4h1v3h-1V3zm0 15h1v3h-1v-3zM3 11h3v1H3v-1zm15 0h3v1h-3v-1zM5.64 5.64l.71-.71L8 6.58l-.71.71-1.65-1.65zm8.36 8.36l.71-.71 1.65 1.65-.71.71-1.65-1.65zm-8.36 0L6.99 13.6 8.64 15.25l-.71.71-1.65-1.65zm8.36-8.36l1.65-1.65.71.71-1.65 1.65-.71-.71z"/>
              <path class="moon" d="M12 2c.7 0 1.38.08 2.03.23A8 8 0 1 0 12 22c-4.42 0-8-3.58-8-8 0-3.53 2.29-6.53 5.47-7.59A7 7 0 0 0 12 2z"/>
            </svg>
          </button>
        </div>
      </div>
    </aside>
    <div class="content">
      <header class="topbar">
        <div class="topbar-left">
          <a class="logo-inline" href="./dashboard.html">
            <img src="../assets/logo.svg" alt="PulseDesk logo">
            <span class="wordmark">PulseDesk</span>
          </a>
        </div>
        <div class="topbar-right">
          <button id="sidebar-toggle" class="sidebar-toggle" type="button" aria-label="Toggle sidebar" aria-expanded="false">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M7 12h10M7 7h10M7 17h10"/></svg>
          </button>
          <div class="avatar">U</div>
        </div>
      </header>
      <main class="main">
        <h1 class="section-title">Dashboard</h1>
        <p class="page-subtitle">Realtime operations overview, SLA trends and agent productivity.</p>
        <div class="dashboard-grid">
          <div class="card">
            <div class="card-title">Assigned Hours</div>
            <svg viewBox="0 0 600 200" width="100%" height="160" aria-hidden="true">
              <polyline points="0,140 60,128 120,132 180,110 240,115 300,100 360,105 420,90 480,95 540,80 600,85"
                        fill="none" stroke="rgba(37,99,235,0.8)" stroke-width="3"/>
              <polyline points="0,160 60,155 120,158 180,148 240,150 300,145 360,142 420,140 480,138 540,136 600,134"
                        fill="none" stroke="rgba(148,163,184,0.8)" stroke-width="2"/>
            </svg>
          </div>
          <div class="stack">
            <div class="card kpi-mini">
              <div class="card-title">SLA Due</div>
              <div id="kpi-overdue" class="kpi-value">—</div>
            </div>
            <div class="card kpi-mini">
              <div class="card-title">Resolution Due</div>
              <div id="kpi-res" class="kpi-value">—</div>
            </div>
            <div class="card kpi-mini">
              <div class="card-title">Unanswered Tickets</div>
              <div id="kpi-pending" class="kpi-value">—</div>
            </div>
          </div>
        </div>
        <div class="split">
          <div class="card">
            <div class="card-title">SLA Overview</div>
            <div class="muted" style="margin-bottom:12px">Response and resolution trends (last 7 days)</div>
            <svg viewBox="0 0 200 60" width="100%" height="60" aria-hidden="true">
              <polyline points="0,40 30,36 60,42 90,28 120,30 150,24 180,26 200,22"
                        fill="none" stroke="rgba(37,99,235,0.6)" stroke-width="2"/>
              <polyline points="0,48 30,44 60,46 90,40 120,38 150,36 180,34 200,32"
                        fill="none" stroke="rgba(148,163,184,0.7)" stroke-width="2"/>
            </svg>
            <div class="summary-grid" style="margin-top:12px">
              <div><div class="label">FRT (avg)</div><div id="sla-frt">—</div></div>
              <div><div class="label">Resolution (avg)</div><div id="sla-res">—</div></div>
              <div><div class="label">Overdue</div><div id="sla-over">—</div></div>
              <div><div class="label">Met SLA</div><div id="sla-met">—</div></div>
            </div>
          </div>
          <div class="card">
            <div class="card-title">Recent Activity</div>
            <div id="activity-list"></div>
          </div>
        </div>
        <div class="split">
          <div class="card">
            <div class="card-title">Pending</div>
            <div class="summary-grid">
              <div><div class="label">Waiting on Agent</div><div>—</div></div>
              <div><div class="label">Waiting on Customer</div><div>—</div></div>
            </div>
          </div>
          <div class="card">
            <div class="card-title">Ticket Rating</div>
            <div class="muted">Latest CSAT ratings</div>
            <div style="height:12px"></div>
            <div class="summary-grid">
              <div><div class="label">Last 7 days</div><div>—</div></div>
              <div><div class="label">All time</div><div>—</div></div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Latest notifications</div>
          <div class="muted">No notifications.</div>
        </div>
        <div class="card">
          <div class="card-title">My Tickets</div>
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Subject</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="my-empty" style="display:none; padding:16px;">
            <p class="muted">No tickets assigned to you.</p>
            <p class="muted">Focus on priority work: pick tickets aligned to SLAs and impact.</p>
            <div style="height:12px"></div>
            <a class="button secondary" href="./tickets.html">Go to Tickets</a>
          </div>
        </div>
        <footer class="footer">PulseDesk © 2026 – Internal Support Platform.</footer>
      </main>
    </div>
  </div>
<script src="../js/app.js"></script>
<script src="../js/storage.js"></script>
<script src="../js/utils.js"></script>
<script src="../js/seed.js"></script>
<script src="../js/theme.js"></script>
<script src="../js/sidebar.js"></script>
<script>
  (function () {
    var S = window.PulseDeskStorage;
    if (!S) return;
    var U = window.PulseDeskUtils || { formatDuration: function(x){ return String(x); }, daysAgoISO: function(){ return new Date(0).toISOString(); } };
    var $open = document.getElementById("kpi-open");
    var $pending = document.getElementById("kpi-pending");
    var $resolved7 = document.getElementById("kpi-resolved7");
    var $frt = document.getElementById("kpi-frt");
    var $res = document.getElementById("kpi-res");
    var $overdue = document.getElementById("kpi-overdue");
    var $myTbody = document.querySelector(".card:last-of-type tbody");
    var $myEmpty = document.getElementById("my-empty");
    var $activity = document.getElementById("activity-list");
    function shortId(id){ id=String(id||""); return id.length>6?id.slice(-6):id; }
    function labelStatus(v){ var m={open:"Open", pending:"Pending", in_progress:"Pending", resolved:"Resolved", closed:"Closed"}; v=String(v||"").toLowerCase(); return m[v]||v||""; }
    function clsStatus(v){ var m={open:"open", pending:"pending", in_progress:"pending", resolved:"resolved", closed:"closed"}; v=String(v||"").toLowerCase(); return m[v]||"open"; }
    function fmtDate(s){ try{ return new Date(s).toLocaleString(); }catch(e){ return s||""; } }
    function msBetween(a,b){ var da=new Date(a).getTime(); var db=new Date(b).getTime(); if (isNaN(da)||isNaN(db)) return null; return (db-da); }
    function get(){ return S.getTickets(); }
    function normStatus(s){ s=String(s||"").toLowerCase(); if (s==="pending") return "pending"; if (s==="in_progress") return "pending"; if (s==="resolved") return "resolved"; return "open"; }
    function renderKPIs(list){
      var open = list.filter(function(t){ return normStatus(t.status)==="open"; }).length;
      var pending = list.filter(function(t){ return normStatus(t.status)==="pending"; }).length;
      var sinceISO = U.daysAgoISO(7);
      var sinceTS = new Date(sinceISO).getTime();
      var resolved7 = list.filter(function(t){ return t.resolvedAt && new Date(t.resolvedAt).getTime() >= sinceTS; }).length;
      var frTickets = list.filter(function(t){ return t.createdAt && new Date(t.createdAt).getTime() >= sinceTS; });
      var frMs = frTickets.map(function(t){
        var fr = t.firstAgentReplyAt || t.firstResponseAt || null;
        if (fr) {
          var ms = msBetween(t.createdAt, fr);
          return ms!=null ? ms : null;
        }
        return null;
      }).filter(function(v){ return v!=null && v>=0; });
      var frAvg = frMs.length ? Math.round(frMs.reduce(function(a,b){return a+b;},0) / frMs.length) : null;
      var resTickets = list.filter(function(t){ return t.resolvedAt && new Date(t.resolvedAt).getTime() >= sinceTS; });
      var resMs = resTickets.map(function(t){
        var ms = msBetween(t.createdAt, t.resolvedAt);
        return ms!=null ? ms : null;
      }).filter(function(v){ return v!=null && v>=0; });
      var resAvg = resMs.length ? Math.round(resMs.reduce(function(a,b){return a+b;},0) / resMs.length) : null;
      var now = Date.now();
      var overdue = list.filter(function(t){
        return normStatus(t.status)!=="resolved" && t.createdAt && (now - new Date(t.createdAt).getTime() > 48*3600*1000);
      }).length;
      $open.textContent = String(open);
      $pending.textContent = String(pending);
      $resolved7.textContent = String(resolved7);
      $frt.textContent = frAvg==null ? "—" : U.formatDuration(frAvg);
      $res.textContent = resAvg==null ? "—" : U.formatDuration(resAvg);
      $overdue.textContent = String(overdue);
    }
    function renderActivity(){
      var evts = S.getRecentEvents(8);
      if (!evts || evts.length===0){ $activity.innerHTML = "<div class='muted'>No recent activity.</div>"; return; }
      var html = evts.map(function(e){
        var label = String(e.message||"");
        if (!label){
          if (e.type==="status") label = "Status: "+(e.from||"")+" → "+(e.to||"");
          else if (e.type==="priority") label = "Priority: "+(e.from||"")+" → "+(e.to||"");
          else if (e.type==="assignee") label = "Assignee: "+(e.from||"")+" → "+(e.to||"");
          else label = String(e.type||"Event");
        }
        var href = "./ticket.html?id="+encodeURIComponent(String(e.ticketId||""));
        return "<div style='display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #e5e7eb;'>"
          +"<div><a href='"+href+"'>Ticket #"+shortId(e.ticketId)+"</a> "+label+"</div>"
          +"<div class='muted'>"+U.timeAgo(e.at)+"</div>"
        +"</div>";
      }).join("");
      $activity.innerHTML = html;
    }
    function renderMy(list){
      var currentAgent = "You";
      var mine = list.filter(function(t){ return String(t.assignee||"") === currentAgent; });
      if (mine.length===0){
        $myTbody.innerHTML = "";
        $myEmpty.style.display = "block";
        return;
      }
      $myEmpty.style.display = "none";
      var html = mine.slice(0,8).map(function(t){
        var href = "./ticket.html?id="+encodeURIComponent(String(t.id));
        return "<tr>"
          +"<td>"+shortId(t.id)+"</td>"
          +"<td>"+(t.title || t.subject || "")+"</td>"
          +"<td><span class='badge badge-status "+clsStatus(t.status)+"'>"+labelStatus(t.status)+"</span></td>"
          +"<td>"+fmtDate(t.createdAt)+"</td>"
          +"<td><a class='button secondary' href='"+href+"'>View</a></td>"
        +"</tr>";
      }).join("");
      $myTbody.innerHTML = html;
    }
    var list = get();
    renderKPIs(list);
    renderActivity();
    renderMy(list);
  })();
</script>
</body>
</html>
