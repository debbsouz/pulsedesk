<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PulseDesk · Dashboard</title>
  <link rel="stylesheet" href="../css/tokens.css">
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/components.css">
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <img src="../assets/logo.svg" alt="PulseDesk logo">
        <span class="name">PulseDesk</span>
      </div>
      <nav class="nav">
        <a class="active" href="./dashboard.html">Dashboard</a>
        <a href="./tickets.html">Tickets</a>
        <a href="./new-ticket.html">New Ticket</a>
        <a href="./settings.html">Settings</a>
        <a href="#">Logout</a>
      </nav>
    </aside>
    <div class="content">
      <header class="topbar">
        <div class="topbar-left">
          <a class="logo-inline" href="./dashboard.html">
            <img src="../assets/logo.svg" alt="PulseDesk logo">
            <span class="wordmark">PulseDesk</span>
          </a>
        </div>
        <div class="topbar-right">
          <div class="avatar">U</div>
        </div>
      </header>
      <main class="main">
        <h1 class="section-title">Dashboard</h1>
        <div class="cards">
          <div class="card">
            <div class="card-title">Open Tickets</div>
            <div id="kpi-open" style="font-size:28px;font-weight:700">—</div>
          </div>
          <div class="card">
            <div class="card-title">Pending Tickets</div>
            <div id="kpi-pending" style="font-size:28px;font-weight:700">—</div>
          </div>
          <div class="card">
            <div class="card-title">Avg First Response (7d)</div>
            <div id="kpi-frt" style="font-size:28px;font-weight:700">—</div>
          </div>
          <div class="card">
            <div class="card-title">Avg Resolution (7d)</div>
            <div id="kpi-res" style="font-size:28px;font-weight:700">—</div>
          </div>
          <div class="card">
            <div class="card-title">Overdue (SLA Breach)</div>
            <div id="kpi-overdue" style="font-size:28px;font-weight:700">—</div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Recent Activity</div>
          <div id="activity-list"></div>
        </div>
        <div class="card">
          <div class="card-title">My Tickets</div>
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Subject</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="my-empty" style="display:none; padding:16px;">
            <p class="muted">No tickets assigned to you.</p>
            <div style="height:12px"></div>
            <a class="button secondary" href="./tickets.html">Go to Tickets</a>
          </div>
        </div>
      </main>
    </div>
  </div>
<script src="../js/app.js"></script>
<script src="../js/storage.js"></script>
<script src="../js/utils.js"></script>
<script src="../js/seed.js"></script>
<script>
  (function () {
    var S = window.PulseDeskStorage;
    if (!S) return;
    var U = window.PulseDeskUtils || { formatDuration: function(x){ return String(x); }, daysAgoISO: function(){ return new Date(0).toISOString(); } };
    var $open = document.getElementById("kpi-open");
    var $pending = document.getElementById("kpi-pending");
    var $frt = document.getElementById("kpi-frt");
    var $res = document.getElementById("kpi-res");
    var $overdue = document.getElementById("kpi-overdue");
    var $myTbody = document.querySelector(".card:last-of-type tbody");
    var $myEmpty = document.getElementById("my-empty");
    var $activity = document.getElementById("activity-list");
    function shortId(id){ id=String(id||""); return id.length>6?id.slice(-6):id; }
    function labelStatus(v){ var m={open:"Open", in_progress:"Pending", resolved:"Resolved", closed:"Closed"}; return m[v]||v||""; }
    function clsStatus(v){ var m={open:"open", in_progress:"pending", resolved:"resolved", closed:"closed"}; return m[v]||"open"; }
    function fmtDate(s){ try{ return new Date(s).toLocaleString(); }catch(e){ return s||""; } }
    function msBetween(a,b){ var da=new Date(a).getTime(); var db=new Date(b).getTime(); if (isNaN(da)||isNaN(db)) return null; return (db-da); }
    function get(){
      return S.getTickets().map(function(t){ return Object.assign({ resolvedAt: t.resolvedAt || null }, t); });
    }
    function firstAgentReplyAt(t){
      var cs = Array.isArray(t.comments) ? t.comments.slice() : [];
      cs.sort(function(a,b){ return new Date(a.at).getTime() - new Date(b.at).getTime(); });
      for (var i=0;i<cs.length;i++){
        if (String(cs[i].author||"") === "Agent") return cs[i].at;
      }
      return null;
    }
    function renderKPIs(list){
      var open = list.filter(function(t){ return t.status==="open"; }).length;
      var pending = list.filter(function(t){ return t.status==="in_progress"; }).length;
      var since = U.daysAgoISO(7);
      var frTickets = list.filter(function(t){ return t.createdAt && (new Date(t.createdAt).getTime() >= new Date(since).getTime()); });
      var frMs = frTickets.map(function(t){
        var fr = firstAgentReplyAt(t);
        if (fr) {
          var ms = msBetween(t.createdAt, fr);
          return ms!=null ? ms : null;
        }
        return null;
      }).filter(function(v){ return v!=null && v>=0; });
      var frAvg = frMs.length ? Math.round(frMs.reduce(function(a,b){return a+b;},0) / frMs.length) : null;
      var resTickets = list.filter(function(t){ return t.resolvedAt && (new Date(t.resolvedAt).getTime() >= new Date(since).getTime()); });
      var resMs = resTickets.map(function(t){
        var ms = msBetween(t.createdAt, t.resolvedAt);
        return ms!=null ? ms : null;
      }).filter(function(v){ return v!=null && v>=0; });
      var resAvg = resMs.length ? Math.round(resMs.reduce(function(a,b){return a+b;},0) / resMs.length) : null;
      var now = Date.now();
      var overdue = list.filter(function(t){
        return t.status!=="resolved" && t.createdAt && (now - new Date(t.createdAt).getTime() > 48*3600*1000);
      }).length;
      $open.textContent = String(open);
      $pending.textContent = String(pending);
      $frt.textContent = frAvg==null ? "—" : U.formatDuration(frAvg);
      $res.textContent = resAvg==null ? "—" : U.formatDuration(resAvg);
      $overdue.textContent = String(overdue);
    }
    function renderActivity(){
      var evts = S.getRecentEvents(6);
      if (!evts || evts.length===0){ $activity.innerHTML = "<div class='muted'>No recent activity.</div>"; return; }
      var html = evts.map(function(e){
        var label = "";
        if (e.type==="status") label = "Status: "+(e.from||"")+" → "+(e.to||"");
        else if (e.type==="priority") label = "Priority: "+(e.from||"")+" → "+(e.to||"");
        else if (e.type==="assignee") label = "Assignee: "+(e.from||"")+" → "+(e.to||"");
        else label = String(e.type||"Event");
        return "<div style='display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #e5e7eb;'>"
          +"<div><strong>#"+shortId(e.ticketId)+"</strong> "+label+"</div>"
          +"<div class='muted'>"+fmtDate(e.at)+"</div>"
        +"</div>";
      }).join("");
      $activity.innerHTML = html;
    }
    function renderMy(list){
      var currentAgent = "You";
      var mine = list.filter(function(t){ return String(t.assignee||"") === currentAgent; });
      if (mine.length===0){
        $myTbody.innerHTML = "";
        $myEmpty.style.display = "block";
        return;
      }
      $myEmpty.style.display = "none";
      var html = mine.slice(0,8).map(function(t){
        var href = "./ticket.html?id="+encodeURIComponent(String(t.id));
        return "<tr>"
          +"<td>"+shortId(t.id)+"</td>"
          +"<td>"+(t.title || t.subject || "")+"</td>"
          +"<td><span class='badge badge-status "+clsStatus(t.status)+"'>"+labelStatus(t.status)+"</span></td>"
          +"<td>"+fmtDate(t.createdAt)+"</td>"
          +"<td><a class='button secondary' href='"+href+"'>View</a></td>"
        +"</tr>";
      }).join("");
      $myTbody.innerHTML = html;
    }
    var list = get();
    renderKPIs(list);
    renderActivity();
    renderMy(list);
  })();
</script>
</body>
</html>
